Kilosort Post-Processing
==============
Clean up Kilosort outputs by removing putative double-counted spikes.

Kilosort occasionally fits a spike template to the residual of another spike. See [this discussion](https://github.com/MouseLand/Kilosort2/issues/29) for more information.

This module aims to correct for this by removing spikes from the same unit or neighboring units that occur within 5 samples (0.16 ms) of one another. This is not ideal, since it can potentially remove legitimate spike times, but on the whole it seems worth it to avoid having spurious zero-time-lag correlation between units.

Note that the data in the phy directory will be overwritten, and can’t be fully recovered without re-running KS2. To compare data with and without duplicate removal, make a copy of the phy output, and run the kilosort_postprocessing module on the copy. Make sure to delete the .phy directory and phy.log file before opening the edited output in phy. If running in the pipeline, a copy of the phy output is made automatically.

The module takes the paramters:

--align_avg_waveform: Offset spike times so that the average waveform minima are aligned with the spike times. Set to false to disable. This can help identify duplicate clusters due to multiple templates fitting the same spikes.
-overlap_window: Maximum time window for counting two spikes as duplicates
-between_unit_distance_um: Maximum radius in um for counting two spikes as duplicates
-deletion_mode: Delete all duplicates from the lower amplitude cluster or delete the spike of each pair that occurs later in time.

With the default parameters, between cluster duplicate are removed from the cluster with lower amplitude.

The summary text files (cluster_Amplitude.tsv, cluster_ContamPct.tsv and cluster_KSLaberl.tsv) are NOT updated after removing the duplicate spikes. The npy files used to generate these are updated.


Running
-------
```
python -m ecephys_spike_sorting.modules.kilosort_postprocessing --input_json <path to input json> --output_json <path to output json>
```
Two arguments must be included:
1. The location of an existing file in JSON format containing a list of paths and parameters.
2. The location to write a file in JSON format containing information generated by the module while it was run.

See the `_schemas.py` file for detailed information about the contents of the input JSON.

Input data
----------
- **Kilosort output files** : .npy files containing spike times, cluster labels, templates, etc.

Output data
-----------
- **Updated Kilosort output files** : overwrites .npy files for spike times, cluster labels, amplitudes, and PC features. 

- **output_summary.csv** : describing the changes made to the data. The five columns are:

1. Cluster label
2. Spikes in cluster after removing duplicates
3. “within cluster” spikes removed
4. “between cluster” spikes removed, summed over all
5. Cluster label of the partner containing the most duplicates
